---
phase: 03-authentication
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [packages/backend/src/utils/jwt.ts, packages/backend/src/middleware/auth.ts, packages/backend/src/routes/auth.ts, packages/backend/src/routes/index.ts, packages/backend/package.json, packages/shared/src/types/auth.ts, packages/shared/src/index.ts]
autonomous: true
---

<objective>
Implement JWT token authentication flow with join endpoint and auth middleware.

Purpose: Users can join with invite code and receive JWT for authenticated requests.
Output: Working /api/auth/join endpoint and auth middleware for protected routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/03-authentication/03-01-SUMMARY.md

# Existing code to build on
@packages/backend/src/db/schema.ts
@packages/backend/src/routes/index.ts
@packages/backend/src/routes/invites.ts
@packages/backend/src/utils/ApiError.ts
@packages/backend/src/middleware/errorHandler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install jose and create JWT utilities</name>
  <files>packages/backend/src/utils/jwt.ts, packages/backend/package.json, packages/backend/.env.example</files>
  <action>
Install jose library (Edge-compatible JWT, works better than jsonwebtoken in modern Node):
```
pnpm add jose --filter @draugar/backend
```

Create JWT utility module:
- Read JWT_SECRET from env (add to .env.example)
- `signToken(payload: { userId: string, name: string })`: Returns JWT string with 30-day expiry
- `verifyToken(token: string)`: Returns decoded payload or throws
- Use HS256 algorithm

JWT payload structure: { userId: string, name: string, iat: number, exp: number }

For family app, 30-day expiry is fine - no refresh token complexity needed.
  </action>
  <verify>pnpm typecheck passes, jose installed in package.json</verify>
  <done>JWT utilities exported and working with jose library</done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware and types</name>
  <files>packages/backend/src/middleware/auth.ts, packages/shared/src/types/auth.ts, packages/shared/src/index.ts</files>
  <action>
Create shared auth types:
- AuthPayload: { userId: string, name: string }
- AuthResponse: { token: string, user: { id: string, name: string } }

Create auth middleware:
- Extract Bearer token from Authorization header
- Verify with verifyToken()
- Attach user to req (extend Express Request type)
- On failure: return 401 via ApiError.unauthorized()

Pattern for extending Express Request:
```typescript
declare global {
  namespace Express {
    interface Request {
      user?: AuthPayload;
    }
  }
}
```
  </action>
  <verify>pnpm typecheck passes across all packages</verify>
  <done>Auth middleware created, shared types exported</done>
</task>

<task type="auto">
  <name>Task 3: Create auth routes with join endpoint</name>
  <files>packages/backend/src/routes/auth.ts, packages/backend/src/routes/index.ts, packages/backend/src/routes/invites.ts</files>
  <action>
Create /api/auth routes:

1. POST /api/auth/join - Join with invite code
   - Body: { code: string, name: string }
   - Validate invite code (query DB, check not used, not expired)
   - Create user in users table
   - Mark invite code as used (set usedBy to new user ID)
   - Sign JWT with user info
   - Response: AuthResponse { token, user: { id, name } }
   - Errors: 400 for invalid/used/expired code

2. GET /api/auth/me - Get current user (protected)
   - Use auth middleware
   - Return user info from JWT payload
   - Response: { id: string, name: string }

3. Update POST /api/invites to require auth
   - Add auth middleware to create endpoint
   - Set createdBy to req.user.userId
   - Validate endpoint remains public (for join flow)

Wire up authRouter in routes/index.ts under /auth path.
  </action>
  <verify>
curl -X POST http://localhost:3001/api/auth/join -H "Content-Type: application/json" -d '{"code":"<valid-code>","name":"Test User"}' returns token
curl http://localhost:3001/api/auth/me -H "Authorization: Bearer <token>" returns user info
  </verify>
  <done>Join flow works end-to-end, protected routes require valid JWT</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm typecheck` passes in all packages
- [ ] POST /api/auth/join creates user and returns JWT
- [ ] GET /api/auth/me returns user with valid JWT
- [ ] GET /api/auth/me returns 401 without JWT
- [ ] POST /api/invites requires auth (401 without token)
- [ ] Invite code marked as used after successful join
</verification>

<success_criteria>
- All tasks completed
- Users can join with invite code and receive JWT
- Protected routes reject requests without valid JWT
- No TypeScript errors across monorepo
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-02-SUMMARY.md`
</output>
