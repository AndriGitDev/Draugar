---
phase: 02-backend-core
plan: 01
subsystem: database
tags: [drizzle-orm, postgresql, pg, typescript]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: pnpm monorepo, @draugar/backend package, @draugar/shared types
provides:
  - PostgreSQL schema with users, locations, invite_codes tables
  - Drizzle ORM connection module
  - InviteCode shared type
  - Database migration configuration
affects: [02-api, 03-authentication, 04-e2e-encryption]

# Tech tracking
tech-stack:
  added: [drizzle-orm, pg, drizzle-kit]
  patterns: [drizzle-schema-relations, pg-pool-connection]

key-files:
  created:
    - packages/backend/src/db/schema.ts
    - packages/backend/src/db/index.ts
    - packages/backend/drizzle.config.ts
    - packages/shared/src/types/invite-code.ts
  modified:
    - packages/backend/package.json
    - packages/backend/.env.example
    - packages/shared/src/index.ts
    - pnpm-lock.yaml

key-decisions:
  - "Drizzle ORM over Prisma for lighter weight and pure TypeScript"
  - "UUID primary keys for all tables"
  - "Nullable encrypted_data column for future E2E encryption"
  - "Invite codes with optional expiration"

patterns-established:
  - "Schema definitions in src/db/schema.ts"
  - "DB connection via src/db/index.ts"
  - "Relations defined for type-safe joins"

# Metrics
duration: 3 min
completed: 2026-01-15
---

# Phase 2 Plan 01: Database Setup Summary

**PostgreSQL schema with Drizzle ORM defining users, locations, and invite_codes tables with type-safe relations**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-15T23:51:25Z
- **Completed:** 2026-01-15T23:54:41Z
- **Tasks:** 3
- **Files created:** 4
- **Files modified:** 4

## Accomplishments

- Installed Drizzle ORM with PostgreSQL driver and migration tooling
- Defined database schema with three core tables: users, locations, invite_codes
- Created Drizzle relations for type-safe joins
- Added InviteCode type to shared package for cross-package type safety
- Configured drizzle-kit for database migrations

## Task Commits

Each task was committed atomically:

1. **Task 1: Install Drizzle ORM and PostgreSQL driver** - `e61bcb3` (chore)
2. **Task 2: Create database schema and connection** - `4b68532` (feat)
3. **Task 3: Update shared types to match schema** - `2084adc` (feat)

## Files Created/Modified

- `packages/backend/src/db/schema.ts` - Drizzle schema with users, locations, invite_codes tables and relations
- `packages/backend/src/db/index.ts` - Database connection module exporting db instance
- `packages/backend/drizzle.config.ts` - Migration configuration for drizzle-kit
- `packages/shared/src/types/invite-code.ts` - InviteCode interface matching DB schema
- `packages/backend/package.json` - Added drizzle-orm, pg, drizzle-kit dependencies
- `packages/backend/.env.example` - Added DATABASE_URL configuration
- `packages/shared/src/index.ts` - Added InviteCode export
- `pnpm-lock.yaml` - Updated with new dependencies

## Decisions Made

- **Drizzle ORM over Prisma** - Lighter weight, no code generation step, pure TypeScript schema definitions, better monorepo compatibility
- **UUID primary keys** - Standard for distributed systems, generated by database
- **Nullable encrypted_data column** - Prepared for future E2E encryption implementation without schema changes
- **Optional expiration on invite codes** - Allows both permanent and time-limited codes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed relations import location**
- **Found during:** Task 2 (Create database schema and connection)
- **Issue:** `relations` was imported from `drizzle-orm/pg-core` but it should come from `drizzle-orm`
- **Fix:** Split import - pgTable etc. from `drizzle-orm/pg-core`, relations from `drizzle-orm`
- **Files modified:** packages/backend/src/db/schema.ts
- **Verification:** pnpm typecheck passes
- **Committed in:** 4b68532 (part of Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor import fix required for correct Drizzle API usage. No scope creep.

## Issues Encountered

None

## Next Phase Readiness

- Database schema ready for API development
- Drizzle migrations can be generated with `drizzle-kit generate`
- Drizzle migrations can be applied with `drizzle-kit migrate`
- TypeScript types aligned between shared package and DB schema
- Ready for 02-02: Express API structure with error handling

---
*Phase: 02-backend-core*
*Completed: 2026-01-15*
