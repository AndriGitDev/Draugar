---
phase: 02-backend-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [packages/backend/package.json, packages/backend/src/db/index.ts, packages/backend/src/db/schema.ts, packages/backend/drizzle.config.ts, packages/shared/src/types/user.ts, packages/shared/src/types/invite-code.ts, packages/shared/src/index.ts]
autonomous: true
---

<objective>
Set up PostgreSQL database with Drizzle ORM and define core schema for users, locations, and invite codes.

Purpose: Establish database foundation that all features build upon - user storage, location history, and authentication data.
Output: Working PostgreSQL connection with typed schema, ready for API development.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

@packages/backend/src/index.ts
@packages/backend/package.json
@packages/shared/src/types/user.ts
@packages/shared/src/types/location.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Drizzle ORM and PostgreSQL driver</name>
  <files>packages/backend/package.json</files>
  <action>
Install drizzle-orm, pg (PostgreSQL client), and drizzle-kit (migrations). Add @types/pg for TypeScript.

Commands:
```bash
cd packages/backend
pnpm add drizzle-orm pg
pnpm add -D drizzle-kit @types/pg
```

Use Drizzle over Prisma because: lighter weight, no code generation step, pure TypeScript schema definitions, better monorepo compatibility.
  </action>
  <verify>pnpm list drizzle-orm pg drizzle-kit shows all packages installed</verify>
  <done>drizzle-orm, pg, drizzle-kit installed as dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and connection</name>
  <files>packages/backend/src/db/index.ts, packages/backend/src/db/schema.ts, packages/backend/drizzle.config.ts, packages/backend/.env.example</files>
  <action>
Create database connection and schema files:

**packages/backend/src/db/schema.ts:**
Define tables using Drizzle's pgTable:
- `users`: id (uuid, primary), name (text), created_at (timestamp)
- `locations`: id (uuid, primary), user_id (uuid, fk to users), latitude (real), longitude (real), accuracy (real), timestamp (timestamp), encrypted_data (text, nullable - for future E2E encryption)
- `invite_codes`: id (uuid, primary), code (text, unique), created_by (uuid, fk to users, nullable - first user has no creator), used_by (uuid, fk to users, nullable), created_at (timestamp), expires_at (timestamp, nullable)

Use Drizzle's `relations` for type-safe joins.

**packages/backend/src/db/index.ts:**
- Import drizzle from 'drizzle-orm/node-postgres'
- Import Pool from 'pg'
- Create connection pool with DATABASE_URL from env
- Export db instance and schema

**packages/backend/drizzle.config.ts:**
Configure drizzle-kit for migrations pointing to schema file and DATABASE_URL.

**Update .env.example:**
Add DATABASE_URL=postgresql://user:password@localhost:5432/draugar
  </action>
  <verify>pnpm typecheck passes in backend package</verify>
  <done>Schema defined with users, locations, invite_codes tables. DB connection configured.</done>
</task>

<task type="auto">
  <name>Task 3: Update shared types to match schema</name>
  <files>packages/shared/src/types/user.ts, packages/shared/src/types/invite-code.ts, packages/shared/src/index.ts</files>
  <action>
Update shared types to align with database schema:

**packages/shared/src/types/user.ts:**
Keep User interface but ensure fields match DB: id (string), name (string), createdAt (Date)

**packages/shared/src/types/invite-code.ts (new file):**
```typescript
export interface InviteCode {
  id: string;
  code: string;
  createdBy: string | null;
  usedBy: string | null;
  createdAt: Date;
  expiresAt: Date | null;
}
```

**packages/shared/src/index.ts:**
Add export for InviteCode type.

Note: Location type already matches schema (userId, latitude, longitude, timestamp, accuracy). The encrypted_data column is DB-only for future E2E implementation.
  </action>
  <verify>pnpm typecheck passes in both shared and backend packages</verify>
  <done>Shared types match database schema. InviteCode type exported.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm typecheck` passes in packages/backend
- [ ] `pnpm typecheck` passes in packages/shared
- [ ] Database schema file exists with three tables defined
- [ ] DB connection module exports db instance
- [ ] drizzle.config.ts exists for migrations
</verification>

<success_criteria>
- All tasks completed
- Drizzle ORM installed and configured
- Schema defines users, locations, invite_codes tables
- Shared types updated with InviteCode
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-core/02-01-SUMMARY.md`
</output>
